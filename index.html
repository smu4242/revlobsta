<html>
<head>
</head>

  <body>
    Enter Revlo Key
    (<a target="blank" href="https://www.revlo.co/settings/api">https://www.revlo.co/settings/api</a>, key will be saved in browser): <br>
    <input name="revlokey" type="password" id="revlokey" class=""/>
    <input type="submit" value="Start" id="revlosubmit" onClick="handleRevloSubmit()"></input>
    <br>
    <h1>Rewards (just fyi lol)</h1>
    <div id="rewards"> ... loading rewards...</div>
    <br>
    <h1>Latest redeems</h1>:
    <div id="hat">...loading redeems...</div>
  </body>

  <script src='lodash.core.min.js'></script>
  <script>
    window.key = null;
    var rewardId = 699561;
    var HAT_DURATION_MINUTES = 15;
    var xhr = new XMLHttpRequest();
    var shouldWork = "withCredentials" in xhr;
    xhr = null;
    if (!shouldWork) {
      alert("THIS WILL PROBABLY NOT WORK :(");
    }

    function arrayByRewardId(rewards) {
      var result = {};
      _.map(rewards, function(r) {
        result[r.reward_id] = r;
      });
      return result;
    }

    function onGetRewards () {
      var json = this.responseText;
      // console.log("response json:", json);
      var obj = JSON.parse(json);
      console.log("rewards response:", obj);
      window.rewards = arrayByRewardId(obj.rewards);
      var rewardsHtml = _.map(window.rewards, function(r) {
        return "<div><br>id:"+ r.reward_id + "; title: '"+ r.title + "'; command: '"+ r.bot_command +"'<br></div>";
      }).join();
      document.getElementById("rewards").innerHTML = "<div><br>" + rewardsHtml + "</div>";

      // only get redemeption after we have the rewards:
      getRedemptions();
    }

    function formatDate(d) {
      var hr = d.getHours();
      var min = d.getMinutes();
      if (min < 10) {
          min = "0" + min;
      }
      var ampm = hr < 12 ? "am" : "pm";
      return " " + hr + ":" + min + " " + ampm;
    }

    function bucketsById(redemptions) {
      var allBuckets = {};
      _.map(redemptions, function(r) {
        var bucket = allBuckets[r.reward_id] || [];
        bucket.push(r);
        allBuckets[r.reward_id] = bucket;
      });
      return allBuckets;
    }

    function formatRedemption(r) {
      console.info("REDEMP:", r);
      var reward = window.rewards[r.reward_id];
      console.info("reward:", reward);
      return "<br>" + reward.bot_command + "'s latest redeem started at: " + formatDate(new Date(r.created_at)) + "<br>";
    }

    function onGetRedemptions () {
      var json = this.responseText;
      // console.log("onGetRedemptions json:", json);
      var obj = JSON.parse(json);
      console.log("onGetRedemptions response:", obj);
      var allRedemptions = obj.redemptions;
      var buckets = bucketsById(allRedemptions);
      console.info("buckets: ", buckets);
      // var hatRedemptions = _.filter(allRedemptions, function(r) {
      //   return r.reward_id === rewardId;
      // });
      // console.log("onGetRedemptions hat redemptions:", hatRedemptions);
      // if (hatRedemptions.length === 0) {
      //   console.info("No hat redemptions!!!");
      // }
      var latests = _.map(buckets, function(b){
        return b[0];
      });
      // var redemptionEndDate = new Date(redemption.created_at);
      // redemptionEndDate.setMinutes(redemptionEndDate.getMinutes() + HAT_DURATION_MINUTES);
      // var startDates = _.map(latests, function(redemption){
      //   return new Date(redemption.created_at);
      // });
      // var redemptionEndDate = new Date(latest.created_at);
      // redemptionEndDate.setMinutes(redemptionEndDate.getMinutes() + HAT_DURATION_MINUTES);
      // console.info("start date:   ", startDates);
      document.getElementById("hat").innerHTML = "<div>"
        + _.map(latests, formatRedemption) + "<br>"
        + "</div>";

    }

    function getRewards() {
      var oReq = new XMLHttpRequest();
      oReq.addEventListener("load", onGetRewards);
      oReq.open("GET", "https://api.revlo.co/1/rewards?page=1");
      oReq.setRequestHeader("x-api-key", key);
      oReq.setRequestHeader("Accept", "application/json");
      // oReq.setRequestHeader("Host", "api.revlo.co:443");
      // oReq.setRequestHeader("Connection", "close");
      oReq.send();
    }

    function getRedemptions() {
      var oReq = new XMLHttpRequest();
      oReq.addEventListener("load", onGetRedemptions);
      oReq.open("GET", "https://api.revlo.co/1/redemptions?page=1");
      oReq.setRequestHeader("x-api-key", key);
      oReq.setRequestHeader("Accept", "application/json");
      // oReq.setRequestHeader("Host", "api.revlo.co:443");
      // oReq.setRequestHeader("Connection", "close");
      oReq.send();
    }

    function handleRevloSubmitWithValue(value) {
      console.info("revlo: " + value);
      if (value != "" && value != null) {
        localStorage.setItem('revlokey', value);
        window.key = value;
        getRewards();

        window.setTimeout(function() {
          // console.info("reloading...");
          // window.location.reload(true);
        }, 1000*5);

      }
    }

    function handleRevloSubmit() {
      console.info("AAAAA", this);
      // event.preventDefault();
      var value = document.getElementById('revlokey').value;
      handleRevloSubmitWithValue(value);
    }

    var oldRevloKey = localStorage.getItem('revlokey');
    if (oldRevloKey) {
      document.getElementById('revlokey').value = oldRevloKey;
    }
    handleRevloSubmitWithValue(oldRevloKey);

  </script>
</html>
